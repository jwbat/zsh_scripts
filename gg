#! python
import json
import subprocess as sp
from os import environ, listdir
from os.path import join, expanduser
from colored import fg
from utils import encrypt, decrypt, compare


# directories
home = expanduser('~')
dotfiles = f'{home}/.dotfiles'
scripts = f'{home}/code/shell/scripts'
repos = [dotfiles, scripts]

fpaths = {
    f'{home}/.zprofile':        f'{dotfiles}/.zprofile.age',
    f'{home}/.zsh_a':           f'{dotfiles}/.zsh_a.age',
    f'{home}/.snowsql/config':  f'{dotfiles}/.snowsql_config.age',
    f'{home}/.aws/config':      f'{dotfiles}/.aws_config.age',
    f'{home}/.aws/credentials': f'{dotfiles}/.aws_credentials.age',
    f'{home}/.sbg-env':         f'{dotfiles}/.sbg-env.age',
    f'{home}/.ui-env':          f'{dotfiles}/.ui-env.age',
}


def add_cert_paths():
    source_dir = f'{home}/macbook_certs'
    dest_dir = f'{dotfiles}/macbook_certs_ageified'
    for fname in listdir(source_dir):
        source_path = join(source_dir, fname)
        dest_path = join(dest_dir, fname)
        fpaths[source_path] = dest_path


def ageify():
    for fpath, fpath_age in fpaths.items():
        encrypt(fpath_age, fpath)


def deageify():
    for fpath, fpath_age in fpaths.items():
        decrypted_path = fpath + '2'
        decrypt(decrypted_path, fpath_age)
        print((fg(190)))
        if compare(fpath, decrypted_path) == 0:
            print('OK', end=' ')
        else:
            print(fg(129) + f' decryption error: {fpath} and {decrypted_path} do not match')
    print()



def update_repos():
    for directory in repos:
        try:
            sp.run(['git', '-C', directory, 'add', '.'], check=True)
            sp.run(['git', '-C', directory, 'commit', '-m', '.'], check=True)
            sp.run(['git', '-C', directory, 'push', '-u', 'origin', 'main'], check=True)
        except sp.CalledProcessError as e:
            print(f'error running git command in {directory}: {e}')


add_cert_paths()
ageify()
update_repos()
deageify()
